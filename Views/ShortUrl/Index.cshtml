@model IReadOnlyList<UrlShortener.Models.Dto.ShortUrlSummaryDto>
@{
    ViewData["Title"] = "Short URLs";
    var isAuthenticated = User.Identity?.IsAuthenticated == true;
    var isAdmin = User.IsInRole("Admin");
}

@Html.AntiForgeryToken()

<div id="url-shortener-root"></div>

@section Scripts {
    <!-- Use built bundle (always use production build) -->
    <script src="~/js/dist/url-shortener.js"></script>
    
    <script>
        // Initialize React App with data from server
        const initialUrls = @Html.Raw(Json.Serialize(Model));
        const isAuthenticated = @(isAuthenticated ? "true" : "false");
        const isAdmin = @(isAdmin ? "true" : "false");
        const currentUser = '@(User.Identity?.Name ?? "")';
        const antiForgeryToken = document.querySelector('input[name="__RequestVerificationToken"]').value;
        const apiBaseUrl = '@Url.Content("~/api/short-urls")';

        const props = {
            initialUrls: initialUrls,
            isAuthenticated: isAuthenticated === true || isAuthenticated === "true",
            isAdmin: isAdmin === true || isAdmin === "true",
            currentUser: currentUser,
            antiForgeryToken: antiForgeryToken,
            apiBaseUrl: apiBaseUrl
        };

        // Wait for the app to be loaded and initialize
        function initializeApp() {
            if (typeof window.initializeUrlShortenerApp === 'function') {
                window.initializeUrlShortenerApp(props);
            } else {
                // Retry after a short delay
                setTimeout(initializeApp, 100);
            }
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeApp);
        } else {
            initializeApp();
        }
    </script>
}

